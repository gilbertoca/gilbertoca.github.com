id=10
title=Para duplicar um banco oracle na mesma maquina
status=published
type=post
guid=http://www.jroller.com/gilbertoca/entry/para_duplicar_um_banco_oracle
permalink=/?p=10
dsq_thread_id=
  - 3514590971
tags=
  - Database
~~~~~~
<!-- google_ad_section_start -->

Atualmente aqui na [Secretaria][1] estamos em um processo de implanta&#231;&#227;o de um [sistema de recursos humanos][2], para ser mais exato, praticamente toda parte de infraestrutura (hardware e software) j&#225; est&#225; pronta para uso. Mas por quest&#245;es que foge ao meu conhecimento (penso ser licita&#231;&#227;o), a fase mais densa (treinamento e uso pelo usu&#225;rio final) est&#225; em fase de planejamento/reestrutura&#231;&#227;o. Bom, apesar dessa, vamos dizer morosidade, tem uma fase desse processo que n&#227;o p&#225;ra: a migra&#231;&#227;o. Nesse processo participam duas equipes: parametriza&#231;&#227;o e a pr&#243;pria migra&#231;&#227;o, o qual nessa &#250;ltima perten&#231;o. A migra&#231;&#227;o &#233; um ciclo constante onde a partir de modifica&#231;&#245;es (parametriza&#231;&#227;o) importantes no banco de produ&#231;&#227;o, &#233; acionado uma requisi&#231;&#227;o de atualiza&#231;&#227;o do banco de migra&#231;&#227;o (utilizado para validar a parametriza&#231;&#227;o com a ativa&#231;&#227;o de fun&#231;&#245;es do sistema de recursos humanos, por exemplo, calculo de folha). Para esse ciclo funcionar tive que realizar uma das tarefas mais comuns para quem administra um banco de dados, que &#233; c&#243;pia/duplica&#231;&#227;o/clonagem de um banco em produ&#231;&#227;o para outro banco (at&#233; mesmo em outro servidor) a ser utilizado como teste. O procedimento descrito aqui, nada mais &#233; do que seq&#252;&#234;ncia descrita na pr&#243;pria [documenta&#231;&#227;o do banco oracle][3]:

  1. [Create an Oracle Password File for the Auxiliary Instance][4]
  2. [Establish Oracle Net Connectivity to the Auxiliary Instance][5]
  3. [Create an Initialization Parameter File for the Auxiliary Instance][6]
  4. [Start the Auxiliary Instance][7]
  5. [Mount or Open the Target Database][8]
  6. [Make Sure You Have the Necessary Backups and Archived Redo Logs (Essencial &#8211; voc&#234; precisa de um backup][9]
  7. [Allocate Auxiliary Channels if Automatic Channels Are Not Configured][10]
  8. [Recrie a tablespace tempor&#225;ria (extra)][11]

### <a name="task1">Task 1: Create an Oracle Password File for the Auxiliary Instance</a>

<pre>cd $ORACLE_HOME/dbs/
orapwd file=$ORACLE_HOME/dbs/orapwbeta password=senha entries=5
</pre>

### <a name="task2">Task 2: Establish Oracle Net Connectivity to the Auxiliary Instance</a>

<pre>vi $ORACLE_HOME/network/admin/tnsnames.ora
BETA =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = oracleibm.secad)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = beta.secad.to.gov.br)
    )
  )
</pre>

#Aten&#231;&#227;o: a cria&#231;&#227;o est&#225;tica de um listener &#233; important&#237;ssima, caso contr&#225;rio vc encontr&#225; problemas de conex&#227;o, como o erro:  
#ORA-12528: TNS:listener: all appropriate instances are blocking new connections 

<pre>vi $ORACLE_HOME/network/admin/listener.ora
# listener.ora Network Configuration File: /opt/oracle/db/10.2.0.1.0/server/network/admin/listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = producao.secad.to.gov.br)
      (ORACLE_HOME = /opt/oracle/db/10.2.0.1.0/server)
      (SID_NAME = producao)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = alfa.secad.to.gov.br)
      (ORACLE_HOME = /opt/oracle/db/10.2.0.1.0/server)
      (SID_NAME = alfa)
    )
    (SID_DESC =
      (GLOBAL_DBNAME = beta.secad.to.gov.br)
      (ORACLE_HOME = /opt/oracle/db/10.2.0.1.0/server)
      (SID_NAME = beta)
    )
  )

LISTENER =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = oracleibm)(PORT = 1521))
  )
</pre>

### <a name="task3">Task 3: Create an Initialization Parameter File for the Auxiliary Instance</a>

#vamos criar primeiro a estrutura de diretorios onde ficar&#227;o os arquivos do banco 

<pre>cd /dm0/oracle/admin/beta
mkdir adump
mkdir arch
mkdir bdump
mkdir cdump
mkdir data
mkdir exp
mkdir pfile
mkdir scripts
mkdir udump
mkdir utlfile
</pre>

#Agora o arquivo de inicializa&#231;&#227;o, para isso vou fazer uma copia do banco original e fazer a mudan&#231;as necess&#225;rias 

<pre>cd /dm0/oracle/admin/beta/pfile/
cp ../../producao/pfile/init.ora.292007145712 initbeta.ora
vi initbeta.ora
</pre>

#Se estiver usando spfile no banco original, crie um arquivo de inicializa&#231;&#227;o (pfile) a partir dele 

<pre>export ORACLE_SID=producao
sqlplus /as sysdba
CREATE PFILE='/dm0/oracle/admin/beta/pfile/initbeta.ora' FROM SPFILE;
</pre>

#Substitua todas as ocorr&#234;ncias do banco anterior

<pre>:g/producao/s//beta/g

#Acrescente mais uma se&#231;&#227;o neste arquivo
###########################################
#  Filename Conversion Initialization Parameters
#  Renaming Datafiles in RMAN DUPLICATE DATABASE
#  Renaming Online Logs in RMAN DUPLICATE DATABASE
###########################################
DB_FILE_NAME_CONVERT=(/dm0/oracle/admin/producao/data/ ,/dm0/oracle/admin/beta/data/)
LOG_FILE_NAME_CONVERT=(/dm0/oracle/admin/producao/data ,/dm0/oracle/admin/beta/data)
</pre>

#Salve o arquivo. Para facilitar a duplica&#231;&#227;o recomenda-se criar um spfile no local padrao da instala&#231;&#227;o. Isso ir&#225; lhe poupar o trabalho quando o rman fizer o shutdwon e startup, ele n&#227;o solicitar&#225; o arquivo de inicializa&#231;&#227;o pfile.

<pre>export ORACLE_SID=beta
sqlplus /as sysdba
CREATE SPFILE FROM PFILE='/dm0/oracle/admin/beta/pfile/initbeta.ora';
</pre>

### <a name="task4">Task 4: Start the Auxiliary Instance</a>

<pre>export ORACLE_SID=beta
sqlplus /as sysdba
STARTUP FORCE NOMOUNT
</pre>

### <a name="task5">Task 5: Mount or Open the Target Database (Opcional &#8211; provavelmente o banco original j&#225; esteja aberto!)</a>

\# conecte-se ao banco de origem

<pre>SQL> CONNECT SYS/oracle@producao AS SYSDBA;

STARTUP MOUNT;#mount or open database origem
</pre>

### <a name="task6">Task 6: Make Sure You Have the Necessary Backups and Archived Redo Logs (Essencial &#8211; voc&#234; precisa de um backup recente, caso contr&#225;rio, a clonagem criar&#225; um banco antigo)</a>

<pre>export ORACLE_SID=producao
rman target /
Recovery Manager: Release 10.2.0.2.0 - Production on Wed Mar 14 18:12:58 2007
Copyright (c) 1982, 2005, Oracle.  All rights reserved.
connected to target database: PRODUCAO (DBID=2991538920)
RMAN> list backup;
using target database control file instead of recovery catalog
List of Backup Sets
===================
</pre>

### <a name="task7">Task 7: Allocate Auxiliary Channels if Automatic Channels Are Not Configured</a>

#Start RMAN with a connection to the target database, the auxiliary instance, and, if applicable, the recovery catalog database  
#Nesta conex&#227;o pode ocorrer um error comum na versao 10g:  
#ORA-12528: TNS:listener: all appropriate instances are blocking new connections  
#Este &#233; um erro conhecido do Oracle 10g onde um SHUTDOWN IMMEDIATE &#233; seguido por um STARTUP MOUNT ou STARTUP FORCE MOUNT. Execute um novo SHUTDOWN no banco e ent&#227;o um STARTUP. Voc&#234; ser&#225; capaz de conectar novamente.  
#Se ainda sim voc&#234; n&#227;o conseguir conectar, inverta as op&#231;&#245;es do rman:  
#Forma alternativa  
#oracle@oracleibm:/dm0/oracle/admin/beta/pfile> export ORACLE_SID=beta  
#oracle@oracleibm:/dm0/oracle/admin/beta/pfile>rman target sys@producao auxiliary / 

<pre>oracle@oracleibm:/dm0/oracle/admin/beta/pfile> export ORACLE_SID=producao
oracle@oracleibm:/dm0/oracle/admin/beta/pfile> rman TARGET /  AUXILIARY SYS@beta

Recovery Manager: Release 10.2.0.2.0 - Production on Thu Mar 15 09:03:41 2007

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

connected to target database: PRODUCAO (DBID=2991538920)
auxiliary database Password:
connected to auxiliary database: BETA (not mounted)

RMAN>
RUN 
{
  # to manually allocate a channel of type sbt issue:
  #ALLOCATE AUXILIARY CHANNEL ch1 DEVICE TYPE sbt;

  # to manually allocate two auxiliary channels for disk issue (specifying 
  # whatever channel id that you want):
  ALLOCATE AUXILIARY CHANNEL aux1 DEVICE TYPE DISK;
  ALLOCATE AUXILIARY CHANNEL aux2 DEVICE TYPE DISK;
  DUPLICATE TARGET DATABASE TO beta;
}
.
.
.
contents of Memory Script:
{
   Alter clone database open resetlogs;
}
executing Memory Script

database opened
Finished Duplicate Db at 15/03/2007 09:55:47

RMAN> quit
</pre>

### <a name="task8">Task 8: Recrie a tablespace tempor&#225;ria (extra)</a>

<pre>#(vers&#227;o 9i e acima)
ALTER DATABASE TEMPFILE '/dm0/oracle/admin/beta/data/temp01.dbf' DROP INCLUDING DATAFILES;
ALTER TABLESPACE TEMP ADD TEMPFILE '/dm0/oracle/admin/beta/data/temp01.dbf' SIZE 200M REUSE AUTOEXTEND ON NEXT 5M MAXSIZE 2000M; 
</pre>

#Outra coisa, como este banco &#233; para teste, devemos desabilitar o modo archive do mesmo

<pre>oracle@oracleibm:/dm0/oracle/admin/beta/pfile> export ORACLE_SID=beta
oracle@oracleibm:/dm0/oracle/admin/beta/pfile> sqlplus / as sysdba
SQL> archive log list
Database log mode              Archive Mode
Automatic archival             Enabled
Archive destination            /opt/oracle/db/10.2.0.1.0/server/dbs/arch
Oldest online log sequence     0
Next log sequence to archive   1
Current log sequence           1

SQL> shutdown immediate
Database closed.
Database dismounted.
ORACLE instance shut down.

SQL> startup mount
ORACLE instance started.
Total System Global Area 1811939328 bytes
Fixed Size                  2071896 bytes
Variable Size             419431080 bytes
Database Buffers         1375731712 bytes
Redo Buffers               14704640 bytes
Database mounted.

SQL> alter database noarchivelog;
Database altered.

SQL> alter database open;
Database altered.

SQL> archive log list
Database log mode              No Archive Mode
Automatic archival             Disabled
Archive destination            /opt/oracle/db/10.2.0.1.0/server/dbs/arch
Oldest online log sequence     0
Current log sequence           1
SQL> 
</pre>

**  
#N&#227;o esquecer de coletar estat&#237;sticas  
**

<pre>begin
dbms_stats.gather_database_stats(options=> 'GATHER AUTO');
end;
</pre>

<!-- google_ad_section_end -->

 [1]: www.secad.to.gov.br
 [2]: http://www.techne.com.br/produtos/produtos.asp?id=4
 [3]: http://download.oracle.com/docs/cd/B19306_01/backup.102/b14191/rcmdupdb.htm#i1006474
 [4]: #task1
 [5]: #task2
 [6]: #task3
 [7]: #task4
 [8]: #task5
 [9]: #task6
 [10]: #task7
 [11]: #task8