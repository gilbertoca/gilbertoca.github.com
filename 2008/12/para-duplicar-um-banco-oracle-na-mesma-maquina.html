<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
    Vivendo e Aprendendo ...
        - Para duplicar um banco oracle na mesma maquina
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Author">
    <meta name="description" content="Static blog generated with JBake">

    <!-- Style -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootswatch/3.1.1/spacelab/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
    <link rel="stylesheet" href="/css/base.css">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav icon -->
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
  </head>
  <body>      
    <nav class="navbar navbar-default navbar-fixed-top " role="navigation">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Vivendo e Aprendendo ...</a>
        </div>
        
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li><a href="/pages/about.html">About me</a></li>
            <li><a href="/pages/contact.html">Contact</a></li>
          </ul>
        
        <!-- Right navigation -->
        <ul class="nav navbar-nav navbar-right">
              <li><a href="http://twitter.com/gilberto_gca" title="Twitter"><i class="fa fa-twitter-square"></i></a></li>
              <li><a href="https://github.com/gilbertoca" title="Github"><i class="fa fa-github-square"></i></a></li>
          <li><a href="/archive.html"><i class="fa fa-list"></i> Archive</a></li>
          <li><a href="/feed.xml" title="Rss"><i class="fa fa-rss"></i> Feed</a></li>
        </ul>
        <!-- Right navigation end -->

      </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav><!-- /.navbar -->

    <!-- Begin page content -->
    <div class="container">
      
      <div class="row">
        <div class="col-md-12">
          <article>
            <div class="page-header"><h1>Para duplicar um banco oracle na mesma maquina</h1>
            </div>
          <p class="post-meta">
            <i class="fa fa-calendar"></i>&nbsp;01 Dezembro 2008&nbsp;&nbsp;
            <i class="fa fa-user"></i>&nbsp;Author&nbsp;&nbsp;
          </p>
              <p>
Atualmente aqui na <a href="www.secad.to.gov.br">Secretaria</a> estamos em um processo de implanta&#231;&#227;o de um <a href="http://www.techne.com.br/produtos/produtos.asp?id=4">sistema de recursos humanos</a>, para ser mais exato, praticamente toda parte de infraestrutura (hardware e software) j&#225; est&#225; pronta para uso. Mas por quest&#245;es que foge ao meu conhecimento (penso ser licita&#231;&#227;o), a fase mais densa (treinamento e uso pelo usu&#225;rio final) est&#225; em fase de planejamento/reestrutura&#231;&#227;o. Bom, apesar dessa, vamos dizer morosidade, tem uma fase desse processo que n&#227;o p&#225;ra: a migra&#231;&#227;o. Nesse processo participam duas equipes: parametriza&#231;&#227;o e a pr&#243;pria migra&#231;&#227;o, o qual nessa &#250;ltima perten&#231;o. A migra&#231;&#227;o &#233; um ciclo constante onde a partir de modifica&#231;&#245;es (parametriza&#231;&#227;o) importantes no banco de produ&#231;&#227;o, &#233; acionado uma requisi&#231;&#227;o de atualiza&#231;&#227;o do banco de  migra&#231;&#227;o (utilizado para validar a parametriza&#231;&#227;o com a ativa&#231;&#227;o de fun&#231;&#245;es do sistema de recursos humanos, por exemplo, calculo de folha). Para esse ciclo funcionar tive que realizar uma das tarefas mais comuns para quem administra um banco de dados, que &#233; c&#243;pia/duplica&#231;&#227;o/clonagem de um banco em produ&#231;&#227;o para outro banco (at&#233; mesmo em outro servidor) a ser utilizado como teste. O procedimento descrito aqui, nada mais &#233; do que seq&#252;&#234;ncia descrita na pr&#243;pria <a href="http://download.oracle.com/docs/cd/B19306_01/backup.102/b14191/rcmdupdb.htm#i1006474">documenta&#231;&#227;o do banco oracle</a>:<br /><br /><ol><br />	<li><a href="#task1">Create an Oracle Password File for the Auxiliary Instance</a></li><br />	<li><a href="#task2">Establish Oracle Net Connectivity to the Auxiliary Instance</a></li><br />	<li><a href="#task3">Create an Initialization Parameter File for the Auxiliary Instance</a></li><br />	<li><a href="#task4">Start the Auxiliary Instance</a></li><br />	<li><a href="#task5">Mount or Open the Target Database</a></li><br />	<li><a href="#task6">Make Sure You Have the Necessary Backups and Archived Redo Logs (Essencial - voc&#234; precisa de um backup</a></li><br />	<li><a href="#task7">Allocate Auxiliary Channels if Automatic Channels Are Not Configured</a></li><br />	<li><a href="#task8">Recrie a tablespace tempor&#225;ria (extra)</a></li><br /></ol><br /><h3><a name="task1">Task 1: Create an Oracle Password File for the Auxiliary Instance</a></h3><br /><p><br /><pre><br />cd $ORACLE_HOME/dbs/<br />orapwd file=$ORACLE_HOME/dbs/orapwbeta password=senha entries=5<br /></pre><br /></p><br /><h3><a name="task2">Task 2: Establish Oracle Net Connectivity to the Auxiliary Instance</a></h3><br /><p><br /><pre><br />vi $ORACLE_HOME/network/admin/tnsnames.ora<br />BETA =<br />  (DESCRIPTION =<br />    (ADDRESS_LIST =<br />      (ADDRESS = (PROTOCOL = TCP)(HOST = oracleibm.secad)(PORT = 1521))<br />    )<br />    (CONNECT_DATA =<br />      (SERVICE_NAME = beta.secad.to.gov.br)<br />    )<br />  )<br /></pre><br /></p><br /><p><br />#Aten&#231;&#227;o: a cria&#231;&#227;o est&#225;tica de um listener &#233; important&#237;ssima, caso contr&#225;rio vc encontr&#225; problemas de conex&#227;o, como o erro:<br />#ORA-12528: TNS:listener: all appropriate instances are blocking new connections<br /></p><br /><p><br /><pre><br />vi $ORACLE_HOME/network/admin/listener.ora<br /># listener.ora Network Configuration File: /opt/oracle/db/10.2.0.1.0/server/network/admin/listener.ora<br /># Generated by Oracle configuration tools.<br /><br />SID_LIST_LISTENER =<br />  (SID_LIST =<br />    (SID_DESC =<br />      (GLOBAL_DBNAME = producao.secad.to.gov.br)<br />      (ORACLE_HOME = /opt/oracle/db/10.2.0.1.0/server)<br />      (SID_NAME = producao)<br />    )<br />    (SID_DESC =<br />      (GLOBAL_DBNAME = alfa.secad.to.gov.br)<br />      (ORACLE_HOME = /opt/oracle/db/10.2.0.1.0/server)<br />      (SID_NAME = alfa)<br />    )<br />    (SID_DESC =<br />      (GLOBAL_DBNAME = beta.secad.to.gov.br)<br />      (ORACLE_HOME = /opt/oracle/db/10.2.0.1.0/server)<br />      (SID_NAME = beta)<br />    )<br />  )<br /><br />LISTENER =<br />  (DESCRIPTION =<br />    (ADDRESS = (PROTOCOL = TCP)(HOST = oracleibm)(PORT = 1521))<br />  )<br /></pre><br /></p><br /><h3><a name="task3">Task 3: Create an Initialization Parameter File for the Auxiliary Instance</a></h3><br /><p><br />#vamos criar primeiro a estrutura de diretorios onde ficar&#227;o os arquivos do banco<br /></p><br /><br /><pre><br />cd /dm0/oracle/admin/beta<br />mkdir adump<br />mkdir arch<br />mkdir bdump<br />mkdir cdump<br />mkdir data<br />mkdir exp<br />mkdir pfile<br />mkdir scripts<br />mkdir udump<br />mkdir utlfile<br /></pre><br /><br /><p><br /><br />#Agora o arquivo de inicializa&#231;&#227;o, para isso vou fazer uma copia do banco original e fazer a mudan&#231;as necess&#225;rias<br /></p><br /><br /><pre><br />cd /dm0/oracle/admin/beta/pfile/<br />cp ../../producao/pfile/init.ora.292007145712 initbeta.ora<br />vi initbeta.ora<br /></pre><br /><br /><p><br />#Se estiver usando spfile no banco original, crie um arquivo de inicializa&#231;&#227;o (pfile) a partir dele<br /></p><br /><pre><br />export ORACLE_SID=producao<br />sqlplus /as sysdba<br />CREATE PFILE='/dm0/oracle/admin/beta/pfile/initbeta.ora' FROM SPFILE;<br /></pre><br />#Substitua todas as ocorr&#234;ncias do banco anterior<br /><pre><br />:g/producao/s//beta/g<br /><br />#Acrescente mais uma se&#231;&#227;o neste arquivo<br />###########################################<br />#  Filename Conversion Initialization Parameters<br />#  Renaming Datafiles in RMAN DUPLICATE DATABASE<br />#  Renaming Online Logs in RMAN DUPLICATE DATABASE<br />###########################################<br />DB_FILE_NAME_CONVERT=(/dm0/oracle/admin/producao/data/ ,/dm0/oracle/admin/beta/data/)<br />LOG_FILE_NAME_CONVERT=(/dm0/oracle/admin/producao/data ,/dm0/oracle/admin/beta/data)<br /></pre><br /><br />#Salve o arquivo. Para facilitar a duplica&#231;&#227;o recomenda-se criar um spfile no local padrao da instala&#231;&#227;o. Isso ir&#225; lhe poupar o trabalho quando o rman fizer o shutdwon e startup, ele n&#227;o solicitar&#225; o arquivo de inicializa&#231;&#227;o pfile.<br /><pre><br />export ORACLE_SID=beta<br />sqlplus /as sysdba<br />CREATE SPFILE FROM PFILE='/dm0/oracle/admin/beta/pfile/initbeta.ora';<br /></pre><br /><br /><br /><h3><a name="task4">Task 4: Start the Auxiliary Instance</a></h3><br /><br /><pre><br />export ORACLE_SID=beta<br />sqlplus /as sysdba<br />STARTUP FORCE NOMOUNT<br /></pre><br /><br /><h3><a name="task5">Task 5: Mount or Open the Target Database (Opcional - provavelmente o banco original j&#225; esteja aberto!)</a></h3><br /><br /># conecte-se ao banco de origem<br /><pre><br />SQL> CONNECT SYS/oracle@producao AS SYSDBA;<br /><br />STARTUP MOUNT;#mount or open database origem<br /></pre><br /><br /><h3><a name="task6">Task 6: Make Sure You Have the Necessary Backups and Archived Redo Logs (Essencial - voc&#234; precisa de um backup recente, caso contr&#225;rio, a clonagem criar&#225; um banco antigo)</a></h3><br /><br /><pre><br />export ORACLE_SID=producao<br />rman target /<br />Recovery Manager: Release 10.2.0.2.0 - Production on Wed Mar 14 18:12:58 2007<br />Copyright (c) 1982, 2005, Oracle.  All rights reserved.<br />connected to target database: PRODUCAO (DBID=2991538920)<br />RMAN> list backup;<br />using target database control file instead of recovery catalog<br />List of Backup Sets<br />===================<br /></pre><br /><br /><h3><a name="task7">Task 7: Allocate Auxiliary Channels if Automatic Channels Are Not Configured</a></h3><br /><p><br />#Start RMAN with a connection to the target database, the auxiliary instance, and, if applicable, the recovery catalog database<br />#Nesta conex&#227;o pode ocorrer um error comum na versao 10g:<br />#ORA-12528: TNS:listener: all appropriate instances are blocking new connections<br />#Este &#233; um erro conhecido do Oracle 10g onde um SHUTDOWN IMMEDIATE &#233; seguido por um STARTUP MOUNT ou STARTUP FORCE MOUNT. Execute um novo SHUTDOWN no banco e ent&#227;o um STARTUP. Voc&#234; ser&#225; capaz de conectar novamente.<br />#Se ainda sim voc&#234; n&#227;o conseguir conectar, inverta as op&#231;&#245;es do rman:<br />#Forma alternativa<br />#oracle@oracleibm:/dm0/oracle/admin/beta/pfile> export ORACLE_SID=beta<br />#oracle@oracleibm:/dm0/oracle/admin/beta/pfile>rman target sys@producao auxiliary /<br /></p><br /><pre><br />oracle@oracleibm:/dm0/oracle/admin/beta/pfile> export ORACLE_SID=producao<br />oracle@oracleibm:/dm0/oracle/admin/beta/pfile> rman TARGET /  AUXILIARY SYS@beta<br /><br />Recovery Manager: Release 10.2.0.2.0 - Production on Thu Mar 15 09:03:41 2007<br /><br />Copyright (c) 1982, 2005, Oracle.  All rights reserved.<br /><br />connected to target database: PRODUCAO (DBID=2991538920)<br />auxiliary database Password:<br />connected to auxiliary database: BETA (not mounted)<br /><br />RMAN><br />RUN <br />{<br />  # to manually allocate a channel of type sbt issue:<br />  #ALLOCATE AUXILIARY CHANNEL ch1 DEVICE TYPE sbt;<br /><br />  # to manually allocate two auxiliary channels for disk issue (specifying <br />  # whatever channel id that you want):<br />  ALLOCATE AUXILIARY CHANNEL aux1 DEVICE TYPE DISK;<br />  ALLOCATE AUXILIARY CHANNEL aux2 DEVICE TYPE DISK;<br />  DUPLICATE TARGET DATABASE TO beta;<br />}<br />.<br />.<br />.<br />contents of Memory Script:<br />{<br />   Alter clone database open resetlogs;<br />}<br />executing Memory Script<br /><br />database opened<br />Finished Duplicate Db at 15/03/2007 09:55:47<br /><br />RMAN> quit<br /></pre><br /><br /><h3><a name="task8">Task 8: Recrie a tablespace tempor&#225;ria (extra)</a></h3><br /><pre><br />#(vers&#227;o 9i e acima)<br />ALTER DATABASE TEMPFILE '/dm0/oracle/admin/beta/data/temp01.dbf' DROP INCLUDING DATAFILES;<br />ALTER TABLESPACE TEMP ADD TEMPFILE '/dm0/oracle/admin/beta/data/temp01.dbf' SIZE 200M REUSE AUTOEXTEND ON NEXT 5M MAXSIZE 2000M; <br /></pre><br />#Outra coisa, como este banco &#233; para teste, devemos desabilitar o modo archive do mesmo<br /><pre><br />oracle@oracleibm:/dm0/oracle/admin/beta/pfile> export ORACLE_SID=beta<br />oracle@oracleibm:/dm0/oracle/admin/beta/pfile> sqlplus / as sysdba<br />SQL> archive log list<br />Database log mode              Archive Mode<br />Automatic archival             Enabled<br />Archive destination            /opt/oracle/db/10.2.0.1.0/server/dbs/arch<br />Oldest online log sequence     0<br />Next log sequence to archive   1<br />Current log sequence           1<br /><br />SQL> shutdown immediate<br />Database closed.<br />Database dismounted.<br />ORACLE instance shut down.<br /><br />SQL> startup mount<br />ORACLE instance started.<br />Total System Global Area 1811939328 bytes<br />Fixed Size                  2071896 bytes<br />Variable Size             419431080 bytes<br />Database Buffers         1375731712 bytes<br />Redo Buffers               14704640 bytes<br />Database mounted.<br /><br />SQL> alter database noarchivelog;<br />Database altered.<br /><br />SQL> alter database open;<br />Database altered.<br /><br />SQL> archive log list<br />Database log mode              No Archive Mode<br />Automatic archival             Disabled<br />Archive destination            /opt/oracle/db/10.2.0.1.0/server/dbs/arch<br />Oldest online log sequence     0<br />Current log sequence           1<br />SQL> <br /></pre><br /><b><br />#N&#227;o esquecer de coletar estat&#237;sticas<br /></b><br /><pre><br />begin<br />dbms_stats.gather_database_stats(options=> 'GATHER AUTO');<br />end;<br /></pre><br />
</p>
      <div class="share">
  <!-- Facebook -->
          <a href="http://www.facebook.com/sharer.php?u=http://blog.gilbertoca.com/2008/12/para-duplicar-um-banco-oracle-na-mesma-maquina.html" target="_blank"><img src="/img/sharebuttons/facebook.png" alt="Facebook" /></a>
  <!-- Google+ -->
  <!-- Twitter -->
          <a href="http://twitter.com/share?url=http://blog.gilbertoca.com/2008/12/para-duplicar-um-banco-oracle-na-mesma-maquina.html&text=Para duplicar um banco oracle na mesma maquina blog.gilbertoca.com/2008/12/para-duplicar-um-banco-oracle-na-mesma-maquina.html" target="_blank"><img src="/img/sharebuttons/twitter.png" alt="Twitter" /></a>
      </div>
            </article>
        </div> <!-- /.col-md-12 -->
      </div> <!-- /.row -->
        
      </div><!-- /.container -->

    <footer>
      <div class="container">
        <hr>
        <div class="row">
          <div class="col-xs-10">
            <p class="text-muted credit">&copy; Gilberto Caetano de Andrade 2014 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.2.1</a> | <i title="Linux" class="fa fa-linux"></i></p>
          </div>
          <div class="col-xs-2 gotop">
            <a href="#"><i class="fa fa-arrow-circle-up"> top</i></a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gist-embed/1.6/gist-embed.min.js"></script>
    
    <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
    <script type="text/javascript">
      <!-- load prettify only when needed -->
      $(document).ready(function(){
        var prettify = false;
        var classToAdd = 'prettyprint snippet';
        $("pre > code").each(function() {
          $("pre > code").parent().addClass(classToAdd);
          prettify = true;
        });
        if(prettify) {
          prettyPrint();
        }
      });
    </script>


        </body>
</html>
